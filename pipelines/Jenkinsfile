pipeline {
    agent any
    environment {
        ZAP_URL = "https://dcodept.unilever.com"
        ZAP_AUTH_URL = "https://dcodept.unilever.com/sso-dev/login"
        ZAP_USER = credentials('zap-username')  // From Jenkins secrets
        ZAP_PASS = credentials('zap-password')  // From Jenkins secrets
        ZAP_DIR = "${WORKSPACE}/zap-reports"
    }
    stages {
        stage('Setup') {
            steps {
                sh 'mkdir -p ${ZAP_DIR}'
                sh 'wget -O zap.conf https://github.com/sunidhiagrawal18/zap/blob/main/configs/zap.conf'
            }
        }
        stage('ZAP Scan') {
            steps {
                script {
                    sh 'docker run -u zap -d --name zap -p 8080:8080 -i owasp/zap2docker-stable zap.sh -daemon -host 0.0.0.0 -port 8080 -config api.disablekey=true'
                    sh 'sleep 30'
                    // ... rest of scan steps ...
                }
            }
        }
    }
    post {
        always {
            node {  // âœ… Fixes "MissingContextVariableException"
                sh 'docker stop zap || true'
                sh 'docker rm zap || true'
                archiveArtifacts artifacts: 'zap-reports/**'
            }
        }
    }
}
